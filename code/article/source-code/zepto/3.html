<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>event 模块 | 戡玉的个人博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="业精于勤荒于嬉，行成于思毁于随">
    
    <link rel="preload" href="/personal-blog/assets/css/0.styles.c9c35cbb.css" as="style"><link rel="preload" href="/personal-blog/assets/js/app.54808727.js" as="script"><link rel="preload" href="/personal-blog/assets/js/2.2104ac0c.js" as="script"><link rel="preload" href="/personal-blog/assets/js/34.c366a736.js" as="script"><link rel="prefetch" href="/personal-blog/assets/js/10.dfa39589.js"><link rel="prefetch" href="/personal-blog/assets/js/100.fe479444.js"><link rel="prefetch" href="/personal-blog/assets/js/101.0482c9d9.js"><link rel="prefetch" href="/personal-blog/assets/js/102.0c6f2fe4.js"><link rel="prefetch" href="/personal-blog/assets/js/103.c3d84fcf.js"><link rel="prefetch" href="/personal-blog/assets/js/104.58960641.js"><link rel="prefetch" href="/personal-blog/assets/js/105.61182d5e.js"><link rel="prefetch" href="/personal-blog/assets/js/106.e5772135.js"><link rel="prefetch" href="/personal-blog/assets/js/11.7c0ec8a5.js"><link rel="prefetch" href="/personal-blog/assets/js/12.d4bbe57e.js"><link rel="prefetch" href="/personal-blog/assets/js/13.c053dc1c.js"><link rel="prefetch" href="/personal-blog/assets/js/14.8e7b7b65.js"><link rel="prefetch" href="/personal-blog/assets/js/15.d8eddf95.js"><link rel="prefetch" href="/personal-blog/assets/js/16.d1c32f9a.js"><link rel="prefetch" href="/personal-blog/assets/js/17.8dcffe71.js"><link rel="prefetch" href="/personal-blog/assets/js/18.9f98c4fd.js"><link rel="prefetch" href="/personal-blog/assets/js/19.779ebecd.js"><link rel="prefetch" href="/personal-blog/assets/js/20.38e30eca.js"><link rel="prefetch" href="/personal-blog/assets/js/21.0d980da0.js"><link rel="prefetch" href="/personal-blog/assets/js/22.84b4a4fd.js"><link rel="prefetch" href="/personal-blog/assets/js/23.b4ab9811.js"><link rel="prefetch" href="/personal-blog/assets/js/24.d47a655e.js"><link rel="prefetch" href="/personal-blog/assets/js/25.e2a76c2e.js"><link rel="prefetch" href="/personal-blog/assets/js/26.ed604d8a.js"><link rel="prefetch" href="/personal-blog/assets/js/27.f494f613.js"><link rel="prefetch" href="/personal-blog/assets/js/28.323a23f3.js"><link rel="prefetch" href="/personal-blog/assets/js/29.dae6be78.js"><link rel="prefetch" href="/personal-blog/assets/js/3.3ace1f43.js"><link rel="prefetch" href="/personal-blog/assets/js/30.b4124c31.js"><link rel="prefetch" href="/personal-blog/assets/js/31.a8135b1c.js"><link rel="prefetch" href="/personal-blog/assets/js/32.5d0a8eca.js"><link rel="prefetch" href="/personal-blog/assets/js/33.1c2223d1.js"><link rel="prefetch" href="/personal-blog/assets/js/35.0e751049.js"><link rel="prefetch" href="/personal-blog/assets/js/36.0762e553.js"><link rel="prefetch" href="/personal-blog/assets/js/37.b7efb722.js"><link rel="prefetch" href="/personal-blog/assets/js/38.af4eb3e8.js"><link rel="prefetch" href="/personal-blog/assets/js/39.aff6f680.js"><link rel="prefetch" href="/personal-blog/assets/js/4.0da6f242.js"><link rel="prefetch" href="/personal-blog/assets/js/40.60f328a4.js"><link rel="prefetch" href="/personal-blog/assets/js/41.219c09a6.js"><link rel="prefetch" href="/personal-blog/assets/js/42.565f9cac.js"><link rel="prefetch" href="/personal-blog/assets/js/43.379d77a8.js"><link rel="prefetch" href="/personal-blog/assets/js/44.20217a97.js"><link rel="prefetch" href="/personal-blog/assets/js/45.237b7a0e.js"><link rel="prefetch" href="/personal-blog/assets/js/46.28ab280b.js"><link rel="prefetch" href="/personal-blog/assets/js/47.60892ffe.js"><link rel="prefetch" href="/personal-blog/assets/js/48.8bd2281d.js"><link rel="prefetch" href="/personal-blog/assets/js/49.bf83154b.js"><link rel="prefetch" href="/personal-blog/assets/js/5.d2d4fe89.js"><link rel="prefetch" href="/personal-blog/assets/js/50.91741583.js"><link rel="prefetch" href="/personal-blog/assets/js/51.99b082c1.js"><link rel="prefetch" href="/personal-blog/assets/js/52.2bf6d39b.js"><link rel="prefetch" href="/personal-blog/assets/js/53.d1fba456.js"><link rel="prefetch" href="/personal-blog/assets/js/54.f3092355.js"><link rel="prefetch" href="/personal-blog/assets/js/55.3bb9cf0f.js"><link rel="prefetch" href="/personal-blog/assets/js/56.f5b8f73b.js"><link rel="prefetch" href="/personal-blog/assets/js/57.566bd46c.js"><link rel="prefetch" href="/personal-blog/assets/js/58.39b49b57.js"><link rel="prefetch" href="/personal-blog/assets/js/59.842e6f13.js"><link rel="prefetch" href="/personal-blog/assets/js/6.e5fd8ee2.js"><link rel="prefetch" href="/personal-blog/assets/js/60.19d037fe.js"><link rel="prefetch" href="/personal-blog/assets/js/61.2632b4cf.js"><link rel="prefetch" href="/personal-blog/assets/js/62.d5d62d8a.js"><link rel="prefetch" href="/personal-blog/assets/js/63.d1965121.js"><link rel="prefetch" href="/personal-blog/assets/js/64.86c602c4.js"><link rel="prefetch" href="/personal-blog/assets/js/65.a2ca0229.js"><link rel="prefetch" href="/personal-blog/assets/js/66.9698b9fd.js"><link rel="prefetch" href="/personal-blog/assets/js/67.4dc73101.js"><link rel="prefetch" href="/personal-blog/assets/js/68.6c0b652f.js"><link rel="prefetch" href="/personal-blog/assets/js/69.31150528.js"><link rel="prefetch" href="/personal-blog/assets/js/7.a49016c2.js"><link rel="prefetch" href="/personal-blog/assets/js/70.d8cad0d6.js"><link rel="prefetch" href="/personal-blog/assets/js/71.4e2d81f7.js"><link rel="prefetch" href="/personal-blog/assets/js/72.3538be59.js"><link rel="prefetch" href="/personal-blog/assets/js/73.9cbed57e.js"><link rel="prefetch" href="/personal-blog/assets/js/74.3d351af3.js"><link rel="prefetch" href="/personal-blog/assets/js/75.254cd25e.js"><link rel="prefetch" href="/personal-blog/assets/js/76.79da9532.js"><link rel="prefetch" href="/personal-blog/assets/js/77.ee3cee56.js"><link rel="prefetch" href="/personal-blog/assets/js/78.9ff41f22.js"><link rel="prefetch" href="/personal-blog/assets/js/79.04a747d3.js"><link rel="prefetch" href="/personal-blog/assets/js/8.6cc2fa0d.js"><link rel="prefetch" href="/personal-blog/assets/js/80.03613ef9.js"><link rel="prefetch" href="/personal-blog/assets/js/81.236324c2.js"><link rel="prefetch" href="/personal-blog/assets/js/82.0e523347.js"><link rel="prefetch" href="/personal-blog/assets/js/83.9ac769fb.js"><link rel="prefetch" href="/personal-blog/assets/js/84.b8526c67.js"><link rel="prefetch" href="/personal-blog/assets/js/85.47a47733.js"><link rel="prefetch" href="/personal-blog/assets/js/86.7be58ea9.js"><link rel="prefetch" href="/personal-blog/assets/js/87.93c8bfc5.js"><link rel="prefetch" href="/personal-blog/assets/js/88.b3272b0c.js"><link rel="prefetch" href="/personal-blog/assets/js/89.9a7989e6.js"><link rel="prefetch" href="/personal-blog/assets/js/9.b1156cdc.js"><link rel="prefetch" href="/personal-blog/assets/js/90.90f13c00.js"><link rel="prefetch" href="/personal-blog/assets/js/91.fb4679c1.js"><link rel="prefetch" href="/personal-blog/assets/js/92.eeeaff8c.js"><link rel="prefetch" href="/personal-blog/assets/js/93.0fafdb8f.js"><link rel="prefetch" href="/personal-blog/assets/js/94.cf391eb0.js"><link rel="prefetch" href="/personal-blog/assets/js/95.39c6f8ec.js"><link rel="prefetch" href="/personal-blog/assets/js/96.db05ff28.js"><link rel="prefetch" href="/personal-blog/assets/js/97.96b6fd68.js"><link rel="prefetch" href="/personal-blog/assets/js/98.8b5bfa79.js"><link rel="prefetch" href="/personal-blog/assets/js/99.6b021a6a.js">
    <link rel="stylesheet" href="/personal-blog/assets/css/0.styles.c9c35cbb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/personal-blog/" class="home-link router-link-active"><!----> <span class="site-name">戡玉的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/personal-blog/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/personal-blog/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/personal-blog/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/personal-blog/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/personal-blog/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/personal-blog/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>文章</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>web前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>游览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/personal-blog/code/article/source-code/zepto/1" class="sidebar-heading clickable open"><span>zepto</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/personal-blog/code/article/source-code/zepto/1.html" class="sidebar-link">整体架构</a></li><li><a href="/personal-blog/code/article/source-code/zepto/2.html" class="sidebar-link">core 模块</a></li><li><a href="/personal-blog/code/article/source-code/zepto/3.html" aria-current="page" class="active sidebar-link">event 模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/personal-blog/code/article/source-code/zepto/3.html#准备知识" class="sidebar-link">准备知识</a></li><li class="sidebar-sub-header"><a href="/personal-blog/code/article/source-code/zepto/3.html#事件创建-代理" class="sidebar-link">事件创建/代理</a></li><li class="sidebar-sub-header"><a href="/personal-blog/code/article/source-code/zepto/3.html#事件绑定-解除" class="sidebar-link">事件绑定/解除</a></li><li class="sidebar-sub-header"><a href="/personal-blog/code/article/source-code/zepto/3.html#事件触发" class="sidebar-link">事件触发</a></li><li class="sidebar-sub-header"><a href="/personal-blog/code/article/source-code/zepto/3.html#事件判断" class="sidebar-link">事件判断</a></li></ul></li><li><a href="/personal-blog/code/article/source-code/zepto/4.html" class="sidebar-link">ajax 模块</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="event-模块"><a href="#event-模块" class="header-anchor">#</a> event 模块</h1> <h2 id="准备知识"><a href="#准备知识" class="header-anchor">#</a> 准备知识</h2> <p>事件的本质就是发布/订阅模式，dom 事件也不例外；先简单说明下发布/订阅模式，dom 事件 api 和兼容性</p> <h3 id="发布-订阅模式"><a href="#发布-订阅模式" class="header-anchor">#</a> 发布/订阅模式</h3> <p>所谓发布/订阅模式，用一个形象的比喻就是买房的人订阅楼房消息，售楼处发布消息，体现为代码的话就是如下形式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Observable <span class="token operator">=</span> <span class="token punctuation">{</span>
  callbacks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">fire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//甲-订阅楼盘消息</span>
Observable<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">&quot;执行动作一 &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//乙-订阅楼盘消息</span>
Observable<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">&quot;执行动作二&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 售楼处-发布消息</span>
Observable<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="dom-event"><a href="#dom-event" class="header-anchor">#</a> DOM/Event</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// eventType   事件类型值</span>
<span class="token comment">// canBubble   事件是否起泡</span>
<span class="token comment">// cancelable  是否可以用preventDefault()方法取消事件</span>

<span class="token keyword">var</span> event <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createEvent</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取事件对象</span>
event<span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span>canBubble<span class="token punctuation">,</span> canBubble<span class="token punctuation">,</span> cancelable<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化事件</span>
dom<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送事件</span>

dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> 处理方法<span class="token punctuation">,</span> canBubble<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定事件</span>
dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> 处理方法<span class="token punctuation">,</span> canBubble<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除事件</span>
</code></pre></div><h3 id="兼容性"><a href="#兼容性" class="header-anchor">#</a> 兼容性</h3> <ol><li><p>focus/blur 和 mouseenter/mouseleave 事件不支持冒泡，因而不能进行事件委托，需要对其进行事件模拟，现代游览器的 focusin 和 focusout 和 mouseover/mouseout 刚好能做到</p></li> <li><p>在鼠标事件中，有一个 relatedTarget 属性，返回与事件的目标节点相关的节点；</p></li> <li><p>mouseover 的 relatedTarget 指向移到目标节点上时离开的节点，mouseout 的 relatedTarget 指向离开所在节点后进入的节点</p></li> <li><p>要模拟 mouseenter/mouseleave，只需确定触发 mouseover/mouseout 上的 relatedTarget 不存在，或者 relatedTarget 不为当前节点且不为当前节点的子节点（避免子节点事件冒泡的影响）</p></li></ol> <p>前要知识了解得差不多了，下面我们来看看 zepto 的 event 实现</p> <h2 id="事件创建-代理"><a href="#事件创建-代理" class="header-anchor">#</a> 事件创建/代理</h2> <h3 id="event"><a href="#event" class="header-anchor">#</a> $.Event</h3> <p>使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建一个点击事件，并允许事件冒泡</span>
$<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> bubbles<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>源码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// zepto代码很喜欢简写成一行, 为了可读性, 我修改如下</span>
$<span class="token punctuation">.</span><span class="token function-variable function">Event</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果type不为字符串类型，做一些处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    props <span class="token operator">=</span> type<span class="token punctuation">;</span>
    type <span class="token operator">=</span> props<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建原生事件, 如果specialEvents[type]不到预设类型，就用Events</span>
  <span class="token keyword">var</span> event <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createEvent</span><span class="token punctuation">(</span>specialEvents<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;Events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 默认事件冒泡</span>
  <span class="token keyword">var</span> bubbles <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在props，来一波Event对象设置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> name <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">&quot;bubbles&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bubbles <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化事件配置</span>
  event<span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> bubbles<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 对事件做一些改造和兼容性处理</span>
  <span class="token keyword">return</span> <span class="token function">compatible</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，$.Event 方法的实现利用了 dom 原生事件 api，做了一些参数处理和事件对象的包装</p> <h3 id="proxy"><a href="#proxy" class="header-anchor">#</a> $.proxy</h3> <p>使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Zepto'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">var</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello from + &quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>$.proxy 方法的作用就是为了改变回调函数的 this 指向，下面看它的实现</p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function-variable function">proxy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果arguments参数超过2个，就说明存在代理参数</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">in</span> arguments <span class="token operator">&amp;&amp;</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果fn是方法，返回代理函数proxyFn</span>
    <span class="token keyword">var</span> <span class="token function-variable function">proxyFn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        args <span class="token operator">?</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> arguments
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    proxyFn<span class="token punctuation">.</span>_zid <span class="token operator">=</span> <span class="token function">zid</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> proxyFn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果context为字符串，则将fn当做对象处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 有参数时，则组装args，重新执行$.proxy方法</span>
      args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>fn<span class="token punctuation">[</span>context<span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span>fn<span class="token punctuation">[</span>context<span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;expected function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其中<code>var proxyFn = function(){ return fn.apply(context, args ? args.concat(slice.call(arguments)) : arguments) }</code>可以整理成如下形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">proxyFn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> proxyArgs<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果调用的时候，传递了参数</span>
    <span class="token comment">// 就跟执行$.proxy时可能传递了的参数做整合</span>
    proxyArgs <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接取调用时传递的参数</span>
    proxyArgs <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> proxyArgs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>$.proxy 方法其实就是做了原生 bind 方法做的事情，只是处理了做了类型判断处理</p> <h2 id="事件绑定-解除"><a href="#事件绑定-解除" class="header-anchor">#</a> 事件绑定/解除</h2> <h3 id="on"><a href="#on" class="header-anchor">#</a> on</h3> <p><strong>使用</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#content'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
elem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
elem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> handler<span class="token punctuation">,</span> type2<span class="token operator">:</span> handler2<span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>源码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将on绑定方法定义在zepto原型上</span>
$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">on</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> one</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> autoRemove<span class="token punctuation">,</span>
    delegator<span class="token punctuation">,</span>
    $<span class="token keyword">this</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 处理{'事件类型':'函数'}的传参形式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isString</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> data<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理非{'事件类型':'函数'}的传参形式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isString</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>callback <span class="token operator">=</span> data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">=</span> selector<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>selector <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> data <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>callback <span class="token operator">=</span> data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果callback为false，直接赋值会返回retunr false的函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> callback <span class="token operator">=</span> returnFalse<span class="token punctuation">;</span>

  <span class="token comment">// 为每个dom元素执行事件绑定处理</span>
  <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果存在one参数，设置只执行一次操作的函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">)</span>
      <span class="token function-variable function">autoRemove</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">remove</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果存在selector参数，创建委托函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
      <span class="token function-variable function">delegator</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过closest方法找到代理元素</span>
        <span class="token comment">// 这也就是绑定未来才出现的元素的秘诀，不是考刷定时器检测未来元素</span>
        <span class="token comment">// 而是当事件触发，代理delegator方法被事件回调执行时进行动态获取</span>
        <span class="token keyword">var</span> evt<span class="token punctuation">,</span>
          match <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">closest</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> element<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">&amp;&amp;</span> match <span class="token operator">!==</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 通过内部createProxy方法创建代理事件对象, 排除非标准属性</span>
          <span class="token comment">// 然后将代理元素和触发事件的元素保存到事件对象中</span>
          evt <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token function">createProxy</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            currentTarget<span class="token operator">:</span> match<span class="token punctuation">,</span>
            liveFired<span class="token operator">:</span> element<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 传入的事件回调函数被执行</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>autoRemove <span class="token operator">||</span> callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
            match<span class="token punctuation">,</span>
            <span class="token punctuation">[</span>evt<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 进行zepto版本的订阅操作，也就是对事件和传入的回调函数进行绑定</span>
    <span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> event<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> data<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> delegator <span class="token operator">||</span> autoRemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>add 实现如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> events<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> data<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> delegator<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// zid方法用于在elementt添加标记序号，便于内部对事件绑定内容进行查找</span>
  <span class="token comment">// handlers为内部定义的对象字面量, 用于根据id存储绑定内容，充当句柄对象容器(内部缓存对象)</span>
  <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token function">zid</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    set <span class="token operator">=</span> handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 以空格进行拆分，遍历各种事件进行绑定</span>
  events<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">s</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果为ready, 走ready流程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token string">&quot;ready&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建回调句柄, parse方法生成基础句柄对象</span>
    <span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
    handler<span class="token punctuation">.</span>sel <span class="token operator">=</span> selector<span class="token punctuation">;</span>

    <span class="token comment">// 对mouseenter, mouseleave事件进行模拟</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>e <span class="token keyword">in</span> hover<span class="token punctuation">)</span>
      <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> related <span class="token operator">=</span> e<span class="token punctuation">.</span>relatedTarget<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>related <span class="token operator">||</span> <span class="token punctuation">(</span>related <span class="token operator">!==</span> <span class="token keyword">this</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>$<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> related<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 继续设置句柄对象</span>
    handler<span class="token punctuation">.</span>del <span class="token operator">=</span> delegator<span class="token punctuation">;</span>
    <span class="token keyword">var</span> callback <span class="token operator">=</span> delegator <span class="token operator">||</span> fn<span class="token punctuation">;</span>
    handler<span class="token punctuation">.</span><span class="token function-variable function">proxy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e <span class="token operator">=</span> <span class="token function">compatible</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果调用了event.stopImmediatePropagation()</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">isImmediatePropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      e<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
      <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
        element<span class="token punctuation">,</span>
        e<span class="token punctuation">.</span>_args <span class="token operator">==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>_args<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果事件回调执行了return false;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    handler<span class="token punctuation">.</span>i <span class="token operator">=</span> set<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// 将句柄对象添加到内部句柄容器handlers, 也就是订阅操作</span>
    set<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 具体绑定操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;addEventListener&quot;</span> <span class="token keyword">in</span> element<span class="token punctuation">)</span>
      element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token function">realEvent</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
        handler<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span>
        <span class="token function">eventCapture</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> capture<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对 focus/blur 和 mouseenter/mouseleave 的模拟和兼容处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 顶部变量定义</span>
<span class="token punctuation">(</span>focusinSupported <span class="token operator">=</span> <span class="token string">&quot;onfocusin&quot;</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>focus <span class="token operator">=</span> <span class="token punctuation">{</span> focus<span class="token operator">:</span> <span class="token string">&quot;focusin&quot;</span><span class="token punctuation">,</span> blur<span class="token operator">:</span> <span class="token string">&quot;focusout&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>hover <span class="token operator">=</span> <span class="token punctuation">{</span> mouseenter<span class="token operator">:</span> <span class="token string">&quot;mouseover&quot;</span><span class="token punctuation">,</span> mouseleave<span class="token operator">:</span> <span class="token string">&quot;mouseout&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 事件传递的形式(捕获/冒泡)</span>
<span class="token comment">// 如果事件为focus/blur事件并且浏览器不支持focusin/focusout时, 设置为true</span>
<span class="token comment">// 为true时, 在捕获阶段处理事件，间接达到冒泡的目的</span>
<span class="token comment">// captureSetting参数在内部并未传递, 通过!!自动转换为false, 做默认值</span>
<span class="token keyword">function</span> <span class="token function">eventCapture</span><span class="token punctuation">(</span><span class="token parameter">handler<span class="token punctuation">,</span> captureSetting</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>del <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>focusinSupported <span class="token operator">&amp;&amp;</span> handler<span class="token punctuation">.</span>e <span class="token keyword">in</span> focus<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>captureSetting
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将focus/blur转换成focusin/focusout，将mouseenter/mouseleave转换成mouseover/mouseout</span>
<span class="token keyword">function</span> <span class="token function">realEvent</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> hover<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>focusinSupported <span class="token operator">&amp;&amp;</span> focus<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="off"><a href="#off" class="header-anchor">#</a> off</h3> <p><strong>使用</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#content'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">var</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
elem<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
elem<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> handler<span class="token punctuation">,</span> type2<span class="token operator">:</span> handler2<span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>源码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">off</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> $<span class="token keyword">this</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 处理{'事件类型':'函数'}的传参形式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isString</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理非{'事件类型':'函数'}的传参形式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isString</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>callback <span class="token operator">=</span> selector<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>selector <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果callback为false，直接赋值会返回retunr false的函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> callback <span class="token operator">=</span> returnFalse<span class="token punctuation">;</span>

  <span class="token comment">// 为每个dom元素执行事件解除处理</span>
  <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>remove 实现如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> events<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过zid方法找回元素的标记序号</span>
  <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token function">zid</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 以空格进行拆分，遍历各种事件进行解除</span>
  <span class="token punctuation">(</span>events <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">s</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过findHandlers方法(操作handlers对象)找回对应的函数句柄，遍历进行绑定解除</span>
    <span class="token function">findHandlers</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> event<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span>handler<span class="token punctuation">.</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;removeEventListener&quot;</span> <span class="token keyword">in</span> element<span class="token punctuation">)</span>
        element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>
          <span class="token function">realEvent</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
          handler<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span>
          <span class="token function">eventCapture</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> capture<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="bind-unbind"><a href="#bind-unbind" class="header-anchor">#</a> bind/unbind</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">unbind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="live-die"><a href="#live-die" class="header-anchor">#</a> live/die</h3> <p>所谓给未来的元素绑定，换汤不换药，都是先通过绑定一个元素，然后执行时再具体查找子元素，再执行回调</p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">live</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> event<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">die</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> event<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="delegate-undelegate"><a href="#delegate-undelegate" class="header-anchor">#</a> delegate/undelegate</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">delegate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> event<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">undelegate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> event<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="one"><a href="#one" class="header-anchor">#</a> one</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">one</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="事件触发"><a href="#事件触发" class="header-anchor">#</a> 事件触发</h2> <h3 id="trigger"><a href="#trigger" class="header-anchor">#</a> trigger</h3> <p><strong>使用</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>源码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 字符串和纯粹Object对象判断, 如果是就创建Event对象, 否则返回处理后的event对象</span>
  event <span class="token operator">=</span>
    <span class="token function">isString</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">||</span> $<span class="token punctuation">.</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
      <span class="token operator">?</span> $<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">compatible</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将参数保存到事件对象上</span>
  event<span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>

  <span class="token comment">// 遍历所有dom元素进行触发操作</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是focus/blur事件, 则直接执行, focus/blur游览器原生支持</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token keyword">in</span> focus <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">[</span>event<span class="token punctuation">.</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span>event<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 存在dispatchEvent则直接执行事件触发</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;dispatchEvent&quot;</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 不存在dispatchEvent时, 则直接执行triggerHandler</span>
    <span class="token keyword">else</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggerHandler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="triggerhandler"><a href="#triggerhandler" class="header-anchor">#</a> triggerHandler</h3> <p><strong>使用</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggerHandler</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是参数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>源码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">triggerHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> e<span class="token punctuation">,</span> result<span class="token punctuation">;</span>

  <span class="token comment">// 遍历所有dom元素进行触发操作</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过内部createProxy方法创建代理事件对象, 排除非标准属性</span>
    <span class="token comment">// 字符串判断, 如果是就创建Event对象, 否则返回处理后的event对象</span>
    e <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">?</span> $<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">:</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将参数保存到事件对象上</span>
    e<span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>

    <span class="token comment">// 将element保存到事件对象上</span>
    e<span class="token punctuation">.</span>target <span class="token operator">=</span> element<span class="token punctuation">;</span>

    <span class="token comment">// 通过findHandlers方法(操作handlers对象)找回对应的函数句柄，遍历进行执行</span>
    $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token function">findHandlers</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> event<span class="token punctuation">.</span>type <span class="token operator">||</span> event<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">isImmediatePropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="事件判断"><a href="#事件判断" class="header-anchor">#</a> 事件判断</h2> <table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">isDefaultPrevented</td> <td style="text-align:left;">如果 preventDefault()被该事件的实例调用，那么返回 true</td></tr> <tr><td style="text-align:left;">isImmediatePropagationStopped</td> <td style="text-align:left;">如果 stopImmediatePropagation()被该事件的实例调用，那么返回 true</td></tr> <tr><td style="text-align:left;">isPropagationStopped</td> <td style="text-align:left;">如果 stopPropagation()被该事件的实例调用，那么返回 true</td></tr></tbody></table> <p>方法实现依赖于内部, 源码如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 顶部变量定义</span>
<span class="token keyword">var</span> <span class="token function-variable function">returnTrue</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">returnFalse</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  eventMethods <span class="token operator">=</span> <span class="token punctuation">{</span>
    preventDefault<span class="token operator">:</span> <span class="token string">&quot;isDefaultPrevented&quot;</span><span class="token punctuation">,</span>
    stopImmediatePropagation<span class="token operator">:</span> <span class="token string">&quot;isImmediatePropagationStopped&quot;</span><span class="token punctuation">,</span>
    stopPropagation<span class="token operator">:</span> <span class="token string">&quot;isPropagationStopped&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 对事件做一些改造和兼容性处理</span>
<span class="token keyword">function</span> <span class="token function">compatible</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">||</span> <span class="token operator">!</span>event<span class="token punctuation">.</span>isDefaultPrevented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    source <span class="token operator">||</span> <span class="token punctuation">(</span>source <span class="token operator">=</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历eventMethods进行原生函数劫持和事件判断函数的支持</span>
    $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>eventMethods<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> predicate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> sourceMethod <span class="token operator">=</span> source<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 通过键进行函数重置, 内部进行事件判断函数的支持</span>
      event<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>predicate<span class="token punctuation">]</span> <span class="token operator">=</span> returnTrue<span class="token punctuation">;</span>
        <span class="token keyword">return</span> sourceMethod <span class="token operator">&amp;&amp;</span> <span class="token function">sourceMethod</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      event<span class="token punctuation">[</span>predicate<span class="token punctuation">]</span> <span class="token operator">=</span> returnFalse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回一个事件发生的时间戳，没有则取执行时的当前时间</span>
    event<span class="token punctuation">.</span>timeStamp <span class="token operator">||</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>timeStamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 是否调用了event.preventDefault()方法</span>
    <span class="token comment">// 是否存在新的defaultPrevented判断属性，存在就用它</span>
    <span class="token comment">// 不存在就用非标准属性returnValue，存在就用它</span>
    <span class="token comment">// 不存在就用老属性方法getPreventDefault</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      source<span class="token punctuation">.</span>defaultPrevented <span class="token operator">!==</span> <span class="token keyword">undefined</span>
        <span class="token operator">?</span> source<span class="token punctuation">.</span>defaultPrevented
        <span class="token operator">:</span> <span class="token string">&quot;returnValue&quot;</span> <span class="token keyword">in</span> source
        <span class="token operator">?</span> source<span class="token punctuation">.</span>returnValue <span class="token operator">===</span> <span class="token boolean">false</span>
        <span class="token operator">:</span> source<span class="token punctuation">.</span>getPreventDefault <span class="token operator">&amp;&amp;</span> source<span class="token punctuation">.</span><span class="token function">getPreventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
      event<span class="token punctuation">.</span>isDefaultPrevented <span class="token operator">=</span> returnTrue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> event<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述就 Zepto 对事件模块的实现，大约 300 行的样子</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/personal-blog/code/article/source-code/zepto/2.html" class="prev">
        core 模块
      </a></span> <span class="next"><a href="/personal-blog/code/article/source-code/zepto/4.html">
        ajax 模块
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/personal-blog/assets/js/app.54808727.js" defer></script><script src="/personal-blog/assets/js/2.2104ac0c.js" defer></script><script src="/personal-blog/assets/js/34.c366a736.js" defer></script>
  </body>
</html>
