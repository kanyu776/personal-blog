<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ajax 模块 | 戡玉的个人博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="业精于勤荒于嬉，行成于思毁于随">
    
    <link rel="preload" href="/assets/css/0.styles.e5c8d458.css" as="style"><link rel="preload" href="/assets/js/app.89584af2.js" as="script"><link rel="preload" href="/assets/js/2.b85b6bc1.js" as="script"><link rel="preload" href="/assets/js/35.ff6725a9.js" as="script"><link rel="prefetch" href="/assets/js/10.f48f662c.js"><link rel="prefetch" href="/assets/js/100.ff3774eb.js"><link rel="prefetch" href="/assets/js/101.f8de727d.js"><link rel="prefetch" href="/assets/js/102.fdd468e2.js"><link rel="prefetch" href="/assets/js/103.9c185187.js"><link rel="prefetch" href="/assets/js/104.ec04e106.js"><link rel="prefetch" href="/assets/js/105.ec2f05ef.js"><link rel="prefetch" href="/assets/js/106.04fa10a3.js"><link rel="prefetch" href="/assets/js/11.a49e6006.js"><link rel="prefetch" href="/assets/js/12.7ff2c931.js"><link rel="prefetch" href="/assets/js/13.6bb5eb8e.js"><link rel="prefetch" href="/assets/js/14.2e9aff51.js"><link rel="prefetch" href="/assets/js/15.5ee936ed.js"><link rel="prefetch" href="/assets/js/16.1241602e.js"><link rel="prefetch" href="/assets/js/17.49ca2bef.js"><link rel="prefetch" href="/assets/js/18.b1bd47e1.js"><link rel="prefetch" href="/assets/js/19.bc10f604.js"><link rel="prefetch" href="/assets/js/20.a53198b4.js"><link rel="prefetch" href="/assets/js/21.a166550c.js"><link rel="prefetch" href="/assets/js/22.3a79ad58.js"><link rel="prefetch" href="/assets/js/23.0d31cbdf.js"><link rel="prefetch" href="/assets/js/24.6126bd11.js"><link rel="prefetch" href="/assets/js/25.68d5f542.js"><link rel="prefetch" href="/assets/js/26.d2ed036c.js"><link rel="prefetch" href="/assets/js/27.5fed1b6c.js"><link rel="prefetch" href="/assets/js/28.4543da2a.js"><link rel="prefetch" href="/assets/js/29.20ceb567.js"><link rel="prefetch" href="/assets/js/3.c44793ab.js"><link rel="prefetch" href="/assets/js/30.bb6fddcc.js"><link rel="prefetch" href="/assets/js/31.a966056c.js"><link rel="prefetch" href="/assets/js/32.6d16ab5b.js"><link rel="prefetch" href="/assets/js/33.aeecee7e.js"><link rel="prefetch" href="/assets/js/34.a1a7b598.js"><link rel="prefetch" href="/assets/js/36.1d944e47.js"><link rel="prefetch" href="/assets/js/37.97f3ce4e.js"><link rel="prefetch" href="/assets/js/38.d4143a9b.js"><link rel="prefetch" href="/assets/js/39.bae6154f.js"><link rel="prefetch" href="/assets/js/4.e785d66f.js"><link rel="prefetch" href="/assets/js/40.08c5087a.js"><link rel="prefetch" href="/assets/js/41.71955676.js"><link rel="prefetch" href="/assets/js/42.0d587eef.js"><link rel="prefetch" href="/assets/js/43.797f934e.js"><link rel="prefetch" href="/assets/js/44.845e1d69.js"><link rel="prefetch" href="/assets/js/45.81dae8cd.js"><link rel="prefetch" href="/assets/js/46.01472961.js"><link rel="prefetch" href="/assets/js/47.f95a2836.js"><link rel="prefetch" href="/assets/js/48.167c3cdf.js"><link rel="prefetch" href="/assets/js/49.12858990.js"><link rel="prefetch" href="/assets/js/5.6ba42e98.js"><link rel="prefetch" href="/assets/js/50.a66586b9.js"><link rel="prefetch" href="/assets/js/51.bcb26779.js"><link rel="prefetch" href="/assets/js/52.c50fa8e9.js"><link rel="prefetch" href="/assets/js/53.79f44752.js"><link rel="prefetch" href="/assets/js/54.28197cb3.js"><link rel="prefetch" href="/assets/js/55.cce40a1f.js"><link rel="prefetch" href="/assets/js/56.d877a329.js"><link rel="prefetch" href="/assets/js/57.ac7b286c.js"><link rel="prefetch" href="/assets/js/58.5f705dab.js"><link rel="prefetch" href="/assets/js/59.bc90563e.js"><link rel="prefetch" href="/assets/js/6.3d2d0cab.js"><link rel="prefetch" href="/assets/js/60.d0971935.js"><link rel="prefetch" href="/assets/js/61.b5391bc8.js"><link rel="prefetch" href="/assets/js/62.1818e32a.js"><link rel="prefetch" href="/assets/js/63.2ce76671.js"><link rel="prefetch" href="/assets/js/64.998f03b3.js"><link rel="prefetch" href="/assets/js/65.809f0522.js"><link rel="prefetch" href="/assets/js/66.340b0933.js"><link rel="prefetch" href="/assets/js/67.a7d526be.js"><link rel="prefetch" href="/assets/js/68.9e55b2ed.js"><link rel="prefetch" href="/assets/js/69.cd1d8a95.js"><link rel="prefetch" href="/assets/js/7.a6b1a25b.js"><link rel="prefetch" href="/assets/js/70.17b18a1a.js"><link rel="prefetch" href="/assets/js/71.39cd45c2.js"><link rel="prefetch" href="/assets/js/72.2b727976.js"><link rel="prefetch" href="/assets/js/73.5b0d3207.js"><link rel="prefetch" href="/assets/js/74.f992e12a.js"><link rel="prefetch" href="/assets/js/75.3511b5f6.js"><link rel="prefetch" href="/assets/js/76.45d3a0a8.js"><link rel="prefetch" href="/assets/js/77.b35f1dc0.js"><link rel="prefetch" href="/assets/js/78.8d27ada2.js"><link rel="prefetch" href="/assets/js/79.03333a9e.js"><link rel="prefetch" href="/assets/js/8.005f0859.js"><link rel="prefetch" href="/assets/js/80.20966bb7.js"><link rel="prefetch" href="/assets/js/81.bbad6aa9.js"><link rel="prefetch" href="/assets/js/82.3cadf2db.js"><link rel="prefetch" href="/assets/js/83.5923885a.js"><link rel="prefetch" href="/assets/js/84.bed49f1e.js"><link rel="prefetch" href="/assets/js/85.8ada4cf4.js"><link rel="prefetch" href="/assets/js/86.23c160fc.js"><link rel="prefetch" href="/assets/js/87.f1b16045.js"><link rel="prefetch" href="/assets/js/88.e59d9fbc.js"><link rel="prefetch" href="/assets/js/89.89b26741.js"><link rel="prefetch" href="/assets/js/9.fae1371e.js"><link rel="prefetch" href="/assets/js/90.13a1c791.js"><link rel="prefetch" href="/assets/js/91.0f5f61fa.js"><link rel="prefetch" href="/assets/js/92.c3d39ec4.js"><link rel="prefetch" href="/assets/js/93.a1f64002.js"><link rel="prefetch" href="/assets/js/94.327219d9.js"><link rel="prefetch" href="/assets/js/95.65616f44.js"><link rel="prefetch" href="/assets/js/96.b64f24b5.js"><link rel="prefetch" href="/assets/js/97.dfec418f.js"><link rel="prefetch" href="/assets/js/98.ae73227d.js"><link rel="prefetch" href="/assets/js/99.38cd213e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e5c8d458.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">戡玉的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>文章</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>web前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>游览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/code/article/source-code/zepto/1" class="sidebar-heading clickable open"><span>zepto</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/code/article/source-code/zepto/1.html" class="sidebar-link">整体架构</a></li><li><a href="/code/article/source-code/zepto/2.html" class="sidebar-link">core 模块</a></li><li><a href="/code/article/source-code/zepto/3.html" class="sidebar-link">event 模块</a></li><li><a href="/code/article/source-code/zepto/4.html" aria-current="page" class="active sidebar-link">ajax 模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/code/article/source-code/zepto/4.html#准备知识" class="sidebar-link">准备知识</a></li><li class="sidebar-sub-header"><a href="/code/article/source-code/zepto/4.html#全局-ajax-事件" class="sidebar-link">全局 ajax 事件</a></li><li class="sidebar-sub-header"><a href="/code/article/source-code/zepto/4.html#全局-ajax-方法" class="sidebar-link">全局 ajax 方法</a></li><li class="sidebar-sub-header"><a href="/code/article/source-code/zepto/4.html#相关内部方法" class="sidebar-link">相关内部方法</a></li><li class="sidebar-sub-header"><a href="/code/article/source-code/zepto/4.html#拓展接口的依托方法" class="sidebar-link">拓展接口的依托方法</a></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ajax-模块"><a href="#ajax-模块" class="header-anchor">#</a> ajax 模块</h1> <h2 id="准备知识"><a href="#准备知识" class="header-anchor">#</a> 准备知识</h2> <p>在看 ajax 实现的时候，如果对 ajax 技术知识不是很懂的话，可以参看下我写的<a href="/code/article/front-end/2.html">ajax 基础知识</a>。</p> <h2 id="全局-ajax-事件"><a href="#全局-ajax-事件" class="header-anchor">#</a> 全局 ajax 事件</h2> <p>默认$.ajaxSettings 设置中的 global 为 true，因此在 Ajax 请求的生命周期内，这些事件将被触发：</p> <table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">ajaxStart</td> <td style="text-align:left;">如果没有其他 Ajax 请求当前活跃将会被触发</td></tr> <tr><td style="text-align:left;">ajaxBeforeSend</td> <td style="text-align:left;">再发送请求前，可以被取消</td></tr> <tr><td style="text-align:left;">ajaxSend</td> <td style="text-align:left;">像 ajaxBeforeSend，但不能取消</td></tr> <tr><td style="text-align:left;">ajaxSuccess</td> <td style="text-align:left;">当返回成功时</td></tr> <tr><td style="text-align:left;">ajaxError</td> <td style="text-align:left;">当有错误时</td></tr> <tr><td style="text-align:left;">ajaxComplete</td> <td style="text-align:left;">请求已经完成后，无论请求是成功或者失败</td></tr> <tr><td style="text-align:left;">ajaxStop</td> <td style="text-align:left;">如果这是最后一个活跃着的 Ajax 请求，将会被触发</td></tr></tbody></table> <p>默认情况下，ajax 事件在 document 对象上触发；然而如果请求的 context 是一个 DOM 节点，该事件会在此节点上触发然后再 DOM 中冒泡；唯一的例外是 ajaxStart 和 ajaxStop 这两个全局事件</p> <h3 id="源码实现如下"><a href="#源码实现如下" class="header-anchor">#</a> 源码实现如下</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 触发事件并返回布尔值</span>
<span class="token keyword">function</span> <span class="token function">triggerAndReturn</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> eventName<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建eventName事件对象</span>
  <span class="token keyword">var</span> event <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 触发对应事件</span>
  <span class="token function">$</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是否调用了preventDefault()</span>
  <span class="token keyword">return</span> <span class="token operator">!</span>event<span class="token punctuation">.</span><span class="token function">isDefaultPrevented</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 触发Ajax全局事件</span>
<span class="token keyword">function</span> <span class="token function">triggerGlobal</span><span class="token punctuation">(</span><span class="token parameter">settings<span class="token punctuation">,</span> context<span class="token punctuation">,</span> eventName<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>global<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">triggerAndReturn</span><span class="token punctuation">(</span>context <span class="token operator">||</span> document<span class="token punctuation">,</span> eventName<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 请求活跃数</span>
$<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 如果没有其他Ajax请求操作，将会被触发(在$.ajax操作开始时会被内部调用)</span>
<span class="token keyword">function</span> <span class="token function">ajaxStart</span><span class="token punctuation">(</span><span class="token parameter">settings</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>global <span class="token operator">&amp;&amp;</span> $<span class="token punctuation">.</span>active<span class="token operator">++</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">triggerGlobal</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;ajaxStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如果这是最后一个活跃着的Ajax请求，将会被触发(在$.ajax操作结束时会被内部调用)</span>
<span class="token keyword">function</span> <span class="token function">ajaxStop</span><span class="token punctuation">(</span><span class="token parameter">settings</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>global <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">--</span>$<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token function">triggerGlobal</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;ajaxStop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 再发送请求前，可以被取消(在$.ajax操作开始时会被内部调用)</span>
<span class="token keyword">function</span> <span class="token function">ajaxBeforeSend</span><span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">,</span> settings</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> context <span class="token operator">=</span> settings<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  <span class="token comment">// 如果在$.ajax中的beforeSend方法中返回了return false</span>
  <span class="token comment">// 如果在全局的ajaxBeforeSend侦听回调中返回了return false</span>
  <span class="token comment">// 那么返回return false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    settings<span class="token punctuation">.</span><span class="token function">beforeSend</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span>
    <span class="token function">triggerGlobal</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token string">&quot;ajaxBeforeSend&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>xhr<span class="token punctuation">,</span> settings<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span>
      <span class="token boolean">false</span>
  <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// ajaxBeforeSend事件侦听中如果没返回return false，那么主动触发ajaxSend事件</span>
  <span class="token function">triggerGlobal</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token string">&quot;ajaxSend&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>xhr<span class="token punctuation">,</span> settings<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 当返回成功时</span>
<span class="token keyword">function</span> <span class="token function">ajaxSuccess</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> deferred</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> context <span class="token operator">=</span> settings<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
    status <span class="token operator">=</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行$.ajax的success方法</span>
  settings<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> xhr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在deferred模块，执行resolveWith方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span> deferred<span class="token punctuation">.</span><span class="token function">resolveWith</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> xhr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 触发ajaxSuccess全局事件</span>
  <span class="token function">triggerGlobal</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token string">&quot;ajaxSuccess&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行ajaxComplete函数</span>
  <span class="token function">ajaxComplete</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 当有错误时</span>
<span class="token keyword">function</span> <span class="token function">ajaxError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> type<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> deferred</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> context <span class="token operator">=</span> settings<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  <span class="token comment">// 执行$.ajax的error方法</span>
  settings<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> type<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在deferred模块，执行resolveWith方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span> deferred<span class="token punctuation">.</span><span class="token function">rejectWith</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">[</span>xhr<span class="token punctuation">,</span> type<span class="token punctuation">,</span> error<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 触发ajaxError全局事件</span>
  <span class="token function">triggerGlobal</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token string">&quot;ajaxError&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> error <span class="token operator">||</span> type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行ajaxComplete函数</span>
  <span class="token function">ajaxComplete</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 请求已经完成后，无论请求是成功或者失败</span>
<span class="token keyword">function</span> <span class="token function">ajaxComplete</span><span class="token punctuation">(</span><span class="token parameter">status<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> context <span class="token operator">=</span> settings<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  <span class="token comment">// 执行$.ajax的complete方法</span>
  settings<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 触发ajaxComplete全局事件</span>
  <span class="token function">triggerGlobal</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token string">&quot;ajaxComplete&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>xhr<span class="token punctuation">,</span> settings<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行ajaxStop函数</span>
  <span class="token function">ajaxStop</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实具体实现很简单，就是通过定义一系列触发函数，在具体的 ajax 接口操作中穿插调用，利用库本身实现的$.Event 模块进行 dom 事件触发</p> <h2 id="全局-ajax-方法"><a href="#全局-ajax-方法" class="header-anchor">#</a> 全局 ajax 方法</h2> <h3 id="ajax"><a href="#ajax" class="header-anchor">#</a> ajax</h3> <p>使用</p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;/projects&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Zepto.js&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
  <span class="token literal-property property">context</span><span class="token operator">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>实现内容如下</p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function-variable function">ajax</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.拷贝传入配置options</span>
  <span class="token comment">// 2.拷贝$.ajaxSettings默认配置</span>
  <span class="token comment">// 3.触发全局ajaxStart事件</span>
  <span class="token comment">// 4.判断是否请求跨域(对settings.crossDomain进行设置)</span>
  <span class="token comment">// 5.取得实际有效的url</span>
  <span class="token comment">// 6.序列化数据</span>
  <span class="token comment">// 7.判断是否为jsonp并进行处理</span>
  <span class="token comment">// 8.获取mime和xhr, 定义内部头部处理方法</span>
  <span class="token comment">// 9.配置核心头部(表明请求类型, 表明能够处理的类型, 强制响应时的mime类型, 确定发送信息至服务器时内容编码类型)</span>
  <span class="token comment">// 10.侦听onreadystatechange</span>
  <span class="token comment">// 11.处理ajaxBeforeSend的情况</span>
  <span class="token comment">// 12.建立xhr.open</span>
  <span class="token comment">// 13.设置header</span>
  <span class="token comment">// 14.超时判断和处理</span>
  <span class="token comment">// 15.执行send</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>具体源码</p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function-variable function">ajax</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拷贝传入配置</span>
  <span class="token keyword">var</span> settings <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 如果存在Deferred模块就创建deferred对象</span>
    deferred <span class="token operator">=</span> $<span class="token punctuation">.</span>Deferred <span class="token operator">&amp;&amp;</span> $<span class="token punctuation">.</span><span class="token function">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    urlAnchor<span class="token punctuation">,</span>
    hashIndex<span class="token punctuation">;</span>
  <span class="token comment">// 拷贝$.ajaxSettings默认配置</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> $<span class="token punctuation">.</span>ajaxSettings<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> settings<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> $<span class="token punctuation">.</span>ajaxSettings<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 触发全局ajaxStart事件</span>
  <span class="token function">ajaxStart</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是否请求跨域</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings<span class="token punctuation">.</span>crossDomain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    urlAnchor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    urlAnchor<span class="token punctuation">.</span>href <span class="token operator">=</span> settings<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token comment">// ie游览器bug——重新赋值可以才能获得host</span>
    urlAnchor<span class="token punctuation">.</span>href <span class="token operator">=</span> urlAnchor<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
    settings<span class="token punctuation">.</span>crossDomain <span class="token operator">=</span>
      originAnchor<span class="token punctuation">.</span>protocol <span class="token operator">+</span> <span class="token string">&quot;//&quot;</span> <span class="token operator">+</span> originAnchor<span class="token punctuation">.</span>host <span class="token operator">!==</span>
      urlAnchor<span class="token punctuation">.</span>protocol <span class="token operator">+</span> <span class="token string">&quot;//&quot;</span> <span class="token operator">+</span> urlAnchor<span class="token punctuation">.</span>host<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果请求url不存在，就以当前页面地址为请求地址</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings<span class="token punctuation">.</span>url<span class="token punctuation">)</span> settings<span class="token punctuation">.</span>url <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在hash，则只取非hash的url部分</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hashIndex <span class="token operator">=</span> settings<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    settings<span class="token punctuation">.</span>url <span class="token operator">=</span> settings<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hashIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 序列化数据</span>
  <span class="token function">serializeData</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置dataType</span>
  <span class="token keyword">var</span> dataType <span class="token operator">=</span> settings<span class="token punctuation">.</span>dataType<span class="token punctuation">,</span>
    hasPlaceholder <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\?.+=\?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在?name=?占位符，就设置dataType为jsonp</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasPlaceholder<span class="token punctuation">)</span> dataType <span class="token operator">=</span> <span class="token string">&quot;jsonp&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果判断条件满足，则不允许缓存，通过添加时间戳实现</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    settings<span class="token punctuation">.</span>cache <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> options<span class="token punctuation">.</span>cache <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span> <span class="token operator">==</span> dataType <span class="token operator">||</span> <span class="token string">&quot;jsonp&quot;</span> <span class="token operator">==</span> dataType<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
    settings<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token function">appendQuery</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token string">&quot;_=&quot;</span> <span class="token operator">+</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果dataType为jsonp</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;jsonp&quot;</span> <span class="token operator">==</span> dataType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不存在占位符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasPlaceholder<span class="token punctuation">)</span>
      <span class="token comment">// 如果settings.jsonp存在，则追加=?</span>
      <span class="token comment">// 如果settings.jsonp为false，则不向url中追加内容</span>
      <span class="token comment">// 否则追加callback=?</span>
      settings<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token function">appendQuery</span><span class="token punctuation">(</span>
        settings<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        settings<span class="token punctuation">.</span>jsonp
          <span class="token operator">?</span> settings<span class="token punctuation">.</span>jsonp <span class="token operator">+</span> <span class="token string">&quot;=?&quot;</span>
          <span class="token operator">:</span> settings<span class="token punctuation">.</span>jsonp <span class="token operator">===</span> <span class="token boolean">false</span>
          <span class="token operator">?</span> <span class="token string">&quot;&quot;</span>
          <span class="token operator">:</span> <span class="token string">&quot;callback=?&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">ajaxJSONP</span><span class="token punctuation">(</span>settings<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据dataType获取mime</span>
  <span class="token keyword">var</span> mime <span class="token operator">=</span> settings<span class="token punctuation">.</span>accepts<span class="token punctuation">[</span>dataType<span class="token punctuation">]</span><span class="token punctuation">,</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setHeader</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      headers<span class="token punctuation">[</span>name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    protocol <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^([\w-]+:)\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
      <span class="token operator">?</span> RegExp<span class="token punctuation">.</span>$1
      <span class="token operator">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>protocol<span class="token punctuation">,</span>
    <span class="token comment">// 获得xhr对象</span>
    xhr <span class="token operator">=</span> settings<span class="token punctuation">.</span><span class="token function">xhr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 存储原生header设置方法</span>
    nativeSetHeader <span class="token operator">=</span> xhr<span class="token punctuation">.</span>setRequestHeader<span class="token punctuation">,</span>
    abortTimeout<span class="token punctuation">;</span>

  <span class="token comment">// 如果存在deferred对象，执行promise</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span> deferred<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 表明请求类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings<span class="token punctuation">.</span>crossDomain<span class="token punctuation">)</span> <span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Requested-With&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 表明能够处理的类型</span>
  <span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> mime <span class="token operator">||</span> <span class="token string">&quot;*/*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 强制响应时的mime类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mime <span class="token operator">=</span> settings<span class="token punctuation">.</span>mimeType <span class="token operator">||</span> mime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mime<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> mime <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span>overrideMimeType <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span><span class="token function">overrideMimeType</span><span class="token punctuation">(</span>mime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 发送信息至服务器时内容编码类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    settings<span class="token punctuation">.</span>contentType <span class="token operator">||</span>
    <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>contentType <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span>
      settings<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span>
      settings<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
    <span class="token function">setHeader</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span>
      settings<span class="token punctuation">.</span>contentType <span class="token operator">||</span> <span class="token string">&quot;application/x-www-form-urlencoded&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置额外的头信息</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> settings<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token function">setHeader</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 重置header设置方法</span>
  xhr<span class="token punctuation">.</span>setRequestHeader <span class="token operator">=</span> setHeader<span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求过程结束</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 重置onreadystatechange为空函数</span>
      xhr<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> empty<span class="token punctuation">;</span>
      <span class="token comment">// 清除终止句柄</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>abortTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> result<span class="token punctuation">,</span>
        error <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果满足请求正常的状态码</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> protocol <span class="token operator">==</span> <span class="token string">&quot;file:&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保证dataType有值</span>
        dataType <span class="token operator">=</span>
          dataType <span class="token operator">||</span>
          <span class="token function">mimeToDataType</span><span class="token punctuation">(</span>
            settings<span class="token punctuation">.</span>mimeType <span class="token operator">||</span> xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据responseType设置result</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseType <span class="token operator">==</span> <span class="token string">&quot;arraybuffer&quot;</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>responseType <span class="token operator">==</span> <span class="token string">&quot;blob&quot;</span><span class="token punctuation">)</span>
          result <span class="token operator">=</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通过settings中dataFilter字段进行数据过滤</span>
            result <span class="token operator">=</span> <span class="token function">ajaxDataFilter</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> dataType<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// (1,eval)确保eval执行的作用域是在window下</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType <span class="token operator">==</span> <span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> eval<span class="token punctuation">)</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType <span class="token operator">==</span> <span class="token string">&quot;xml&quot;</span><span class="token punctuation">)</span> result <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseXML<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType <span class="token operator">==</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span>
              result <span class="token operator">=</span> blankRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> e<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 如果error有值，发出转换异常</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">ajaxError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token string">&quot;parsererror&quot;</span><span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">ajaxSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">ajaxError</span><span class="token punctuation">(</span>
          xhr<span class="token punctuation">.</span>statusText <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          xhr<span class="token punctuation">.</span>status <span class="token operator">?</span> <span class="token string">&quot;error&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;abort&quot;</span><span class="token punctuation">,</span>
          xhr<span class="token punctuation">,</span>
          settings<span class="token punctuation">,</span>
          deferred
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果ajaxBeforeSend侦听存在return false操作，则取消请求，发送异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ajaxBeforeSend</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> settings<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    xhr<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ajaxError</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;abort&quot;</span><span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> async <span class="token operator">=</span> <span class="token string">&quot;async&quot;</span> <span class="token keyword">in</span> settings <span class="token operator">?</span> settings<span class="token punctuation">.</span>async <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 附带username&amp;password凭据字段参数</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>
    settings<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    settings<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
    async<span class="token punctuation">,</span>
    settings<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
    settings<span class="token punctuation">.</span>password
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 复制其它配置到xhr实例上</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>xhrFields<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> settings<span class="token punctuation">.</span>xhrFields<span class="token punctuation">)</span> xhr<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> settings<span class="token punctuation">.</span>xhrFields<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 真正设置header</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> headers<span class="token punctuation">)</span> <span class="token function">nativeSetHeader</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> headers<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在超时设置，执行超时处理，发送超时异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    abortTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      xhr<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> empty<span class="token punctuation">;</span>
      xhr<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ajaxError</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;timeout&quot;</span><span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> settings<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 避免发送空字符串</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>data <span class="token operator">?</span> settings<span class="token punctuation">.</span>data <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="相关内部方法"><a href="#相关内部方法" class="header-anchor">#</a> 相关内部方法</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过mime值得到dateType</span>
<span class="token keyword">function</span> <span class="token function">mimeToDataType</span><span class="token punctuation">(</span><span class="token parameter">mime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mime<span class="token punctuation">)</span> mime <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;;&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>mime <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>mime <span class="token operator">==</span> htmlType
        <span class="token operator">?</span> <span class="token string">&quot;html&quot;</span>
        <span class="token operator">:</span> mime <span class="token operator">==</span> jsonType
        <span class="token operator">?</span> <span class="token string">&quot;json&quot;</span>
        <span class="token operator">:</span> scriptTypeRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>mime<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token string">&quot;script&quot;</span>
        <span class="token operator">:</span> xmlTypeRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>mime<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token string">&quot;text&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对url添加Query</span>
<span class="token keyword">function</span> <span class="token function">appendQuery</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> url<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[&amp;?]{1,2}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 序列化数据($.param实现可看具体源码)</span>
<span class="token keyword">function</span> <span class="token function">serializeData</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果processData属性为true，并且存在的数据不为字符串，则调用$.param序列化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>processData <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> $<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">,</span> options<span class="token punctuation">.</span>traditional<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果请求为get或jsonp，则调用appendQueryj将data追加到url</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    options<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>type <span class="token operator">||</span>
      options<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;GET&quot;</span> <span class="token operator">||</span>
      <span class="token string">&quot;jsonp&quot;</span> <span class="token operator">==</span> options<span class="token punctuation">.</span>dataType<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
    <span class="token punctuation">(</span>options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token function">appendQuery</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>url<span class="token punctuation">,</span> options<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>options<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 数据过滤</span>
<span class="token keyword">function</span> <span class="token function">ajaxDataFilter</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> type<span class="token punctuation">,</span> settings</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>dataFilter <span class="token operator">==</span> empty<span class="token punctuation">)</span> <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token keyword">var</span> context <span class="token operator">=</span> settings<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  <span class="token keyword">return</span> settings<span class="token punctuation">.</span><span class="token function">dataFilter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> data<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="get"><a href="#get" class="header-anchor">#</a> get</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token comment">/* url, data, success, dataType */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token function">parseArguments</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="post"><a href="#post" class="header-anchor">#</a> post</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function-variable function">post</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token comment">/* url, data, success, dataType */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token function">parseArguments</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="getjson"><a href="#getjson" class="header-anchor">#</a> getJSON</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function-variable function">getJSON</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token comment">/* url, data, success */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token function">parseArguments</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>dataType <span class="token operator">=</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="拓展接口的依托方法"><a href="#拓展接口的依托方法" class="header-anchor">#</a> 拓展接口的依托方法</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> success<span class="token punctuation">,</span> dataType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>dataType <span class="token operator">=</span> success<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>success <span class="token operator">=</span> data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dataType <span class="token operator">=</span> success<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>success <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
    <span class="token literal-property property">success</span><span class="token operator">:</span> success<span class="token punctuation">,</span>
    <span class="token literal-property property">dataType</span><span class="token operator">:</span> dataType<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="load"><a href="#load" class="header-anchor">#</a> load</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> success</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不存在zepto对象就不执行操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取zepto对象，url根据空格生成数组</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
    parts <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    selector<span class="token punctuation">,</span>
    <span class="token comment">// 获取默认请求配置</span>
    options <span class="token operator">=</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> success<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 存储回调函数</span>
    callback <span class="token operator">=</span> options<span class="token punctuation">.</span>success<span class="token punctuation">;</span>
  <span class="token comment">// 根据parts分理出url和选择器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>url <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>selector <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 修改success</span>
  options<span class="token punctuation">.</span><span class="token function-variable function">success</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果存在选择器，就取response里选择器的部分，否则取全部</span>
    self<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>
      selector
        <span class="token operator">?</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;div&gt;&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rscript<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
        <span class="token operator">:</span> response
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="ajaxjsonp"><a href="#ajaxjsonp" class="header-anchor">#</a> ajaxJSONP</h3> <p>使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// options就是$.ajax方法的options，主要传递`jsonpCallback:全局jsonp函数名`</span>
$<span class="token punctuation">.</span><span class="token function">ajaxJSONP</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>源码</p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function-variable function">ajaxJSONP</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> deferred</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不存在type的时候就走正常的ajax流程，使用默认type</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span> <span class="token keyword">in</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取全局JSONP回调函数的字符串名</span>
  <span class="token keyword">var</span> _callbackName <span class="token operator">=</span> options<span class="token punctuation">.</span>jsonpCallback<span class="token punctuation">,</span>
    callbackName <span class="token operator">=</span>
      <span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>_callbackName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">_callbackName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> _callbackName<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token string">&quot;Zepto&quot;</span> <span class="token operator">+</span> jsonpID<span class="token operator">++</span><span class="token punctuation">,</span>
    <span class="token comment">// 创建script标签</span>
    script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 存储全局JSONP回调函数的引用</span>
    originalCallback <span class="token operator">=</span> window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span><span class="token punctuation">,</span>
    responseData<span class="token punctuation">,</span>
    <span class="token comment">// 定义取消方法</span>
    <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">errorType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">$</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggerHandler</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> errorType <span class="token operator">||</span> <span class="token string">&quot;abort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    xhr <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">abort</span><span class="token operator">:</span> abort <span class="token punctuation">}</span><span class="token punctuation">,</span>
    abortTimeout<span class="token punctuation">;</span>

  <span class="token comment">// 如果存在deferred，执行promise方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span> deferred<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 对script标签定义load error方法</span>
  <span class="token function">$</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;load error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> errorType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 清除定时函数，去除script标签</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>abortTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 操作成功和失败时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;error&quot;</span> <span class="token operator">||</span> <span class="token operator">!</span>responseData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ajaxError</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> errorType <span class="token operator">||</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> options<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">ajaxSuccess</span><span class="token punctuation">(</span>responseData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> options<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 交还全局jsonp函数引用</span>
    window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> originalCallback<span class="token punctuation">;</span>
    <span class="token comment">// 如果存在返回数据和全局jsonp函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseData <span class="token operator">&amp;&amp;</span> $<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>originalCallback<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">originalCallback</span><span class="token punctuation">(</span>responseData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重置变量</span>
    originalCallback <span class="token operator">=</span> responseData <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果ajaxBeforeSend侦听存在return false操作，则执行取消</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ajaxBeforeSend</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">abort</span><span class="token punctuation">(</span><span class="token string">&quot;abort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 重置全局jsonp回调函数，用于获取数据</span>
  window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    responseData <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 对script标签设置url(发送请求)</span>
  script<span class="token punctuation">.</span>src <span class="token operator">=</span> options<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\?(.+)=\?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;?$1=&quot;</span> <span class="token operator">+</span> callbackName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在延迟设置，则定时执行取消</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    abortTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">abort</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>ajaxJSONP 实现的关键在于，对全局 jsonp 函数引用的存取和交还</strong></p> <p>一开始将原始函数引用进行存储</p> <div class="language-js extra-class"><pre class="language-js"><code>originalCallback <span class="token operator">=</span> window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>接着重置它用于在 script 请求后被执行以便获得返回数据</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  responseData <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> options<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\?(.+)=\?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;?$1=&quot;</span> <span class="token operator">+</span> callbackName<span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后在 script 标签的 load 事件触发后，执行存储的原始函数并把数据传递过去</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;load error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> errorType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ....</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>responseData <span class="token operator">&amp;&amp;</span> $<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>originalCallback<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">originalCallback</span><span class="token punctuation">(</span>responseData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ....</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/code/article/source-code/zepto/3.html" class="prev">
        event 模块
      </a></span> <span class="next"><a href="/code/article/tool/1.html">
        本地微信公众号页面开发调试配置
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.89584af2.js" defer></script><script src="/assets/js/2.b85b6bc1.js" defer></script><script src="/assets/js/35.ff6725a9.js" defer></script>
  </body>
</html>
