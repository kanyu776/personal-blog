<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>游览器解析与渲染 | 戡玉的个人博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="业精于勤荒于嬉，行成于思毁于随">
    
    <link rel="preload" href="/assets/css/0.styles.e5c8d458.css" as="style"><link rel="preload" href="/assets/js/app.89584af2.js" as="script"><link rel="preload" href="/assets/js/2.b85b6bc1.js" as="script"><link rel="preload" href="/assets/js/12.7ff2c931.js" as="script"><link rel="prefetch" href="/assets/js/10.f48f662c.js"><link rel="prefetch" href="/assets/js/100.ff3774eb.js"><link rel="prefetch" href="/assets/js/101.f8de727d.js"><link rel="prefetch" href="/assets/js/102.fdd468e2.js"><link rel="prefetch" href="/assets/js/103.9c185187.js"><link rel="prefetch" href="/assets/js/104.ec04e106.js"><link rel="prefetch" href="/assets/js/105.ec2f05ef.js"><link rel="prefetch" href="/assets/js/106.04fa10a3.js"><link rel="prefetch" href="/assets/js/11.a49e6006.js"><link rel="prefetch" href="/assets/js/13.6bb5eb8e.js"><link rel="prefetch" href="/assets/js/14.2e9aff51.js"><link rel="prefetch" href="/assets/js/15.5ee936ed.js"><link rel="prefetch" href="/assets/js/16.1241602e.js"><link rel="prefetch" href="/assets/js/17.49ca2bef.js"><link rel="prefetch" href="/assets/js/18.b1bd47e1.js"><link rel="prefetch" href="/assets/js/19.bc10f604.js"><link rel="prefetch" href="/assets/js/20.a53198b4.js"><link rel="prefetch" href="/assets/js/21.a166550c.js"><link rel="prefetch" href="/assets/js/22.3a79ad58.js"><link rel="prefetch" href="/assets/js/23.0d31cbdf.js"><link rel="prefetch" href="/assets/js/24.6126bd11.js"><link rel="prefetch" href="/assets/js/25.68d5f542.js"><link rel="prefetch" href="/assets/js/26.d2ed036c.js"><link rel="prefetch" href="/assets/js/27.5fed1b6c.js"><link rel="prefetch" href="/assets/js/28.4543da2a.js"><link rel="prefetch" href="/assets/js/29.20ceb567.js"><link rel="prefetch" href="/assets/js/3.c44793ab.js"><link rel="prefetch" href="/assets/js/30.bb6fddcc.js"><link rel="prefetch" href="/assets/js/31.a966056c.js"><link rel="prefetch" href="/assets/js/32.6d16ab5b.js"><link rel="prefetch" href="/assets/js/33.aeecee7e.js"><link rel="prefetch" href="/assets/js/34.a1a7b598.js"><link rel="prefetch" href="/assets/js/35.ff6725a9.js"><link rel="prefetch" href="/assets/js/36.1d944e47.js"><link rel="prefetch" href="/assets/js/37.97f3ce4e.js"><link rel="prefetch" href="/assets/js/38.d4143a9b.js"><link rel="prefetch" href="/assets/js/39.bae6154f.js"><link rel="prefetch" href="/assets/js/4.e785d66f.js"><link rel="prefetch" href="/assets/js/40.08c5087a.js"><link rel="prefetch" href="/assets/js/41.71955676.js"><link rel="prefetch" href="/assets/js/42.0d587eef.js"><link rel="prefetch" href="/assets/js/43.797f934e.js"><link rel="prefetch" href="/assets/js/44.845e1d69.js"><link rel="prefetch" href="/assets/js/45.81dae8cd.js"><link rel="prefetch" href="/assets/js/46.01472961.js"><link rel="prefetch" href="/assets/js/47.f95a2836.js"><link rel="prefetch" href="/assets/js/48.167c3cdf.js"><link rel="prefetch" href="/assets/js/49.12858990.js"><link rel="prefetch" href="/assets/js/5.6ba42e98.js"><link rel="prefetch" href="/assets/js/50.a66586b9.js"><link rel="prefetch" href="/assets/js/51.bcb26779.js"><link rel="prefetch" href="/assets/js/52.c50fa8e9.js"><link rel="prefetch" href="/assets/js/53.79f44752.js"><link rel="prefetch" href="/assets/js/54.28197cb3.js"><link rel="prefetch" href="/assets/js/55.cce40a1f.js"><link rel="prefetch" href="/assets/js/56.d877a329.js"><link rel="prefetch" href="/assets/js/57.ac7b286c.js"><link rel="prefetch" href="/assets/js/58.5f705dab.js"><link rel="prefetch" href="/assets/js/59.bc90563e.js"><link rel="prefetch" href="/assets/js/6.3d2d0cab.js"><link rel="prefetch" href="/assets/js/60.d0971935.js"><link rel="prefetch" href="/assets/js/61.b5391bc8.js"><link rel="prefetch" href="/assets/js/62.1818e32a.js"><link rel="prefetch" href="/assets/js/63.2ce76671.js"><link rel="prefetch" href="/assets/js/64.998f03b3.js"><link rel="prefetch" href="/assets/js/65.809f0522.js"><link rel="prefetch" href="/assets/js/66.340b0933.js"><link rel="prefetch" href="/assets/js/67.a7d526be.js"><link rel="prefetch" href="/assets/js/68.9e55b2ed.js"><link rel="prefetch" href="/assets/js/69.cd1d8a95.js"><link rel="prefetch" href="/assets/js/7.a6b1a25b.js"><link rel="prefetch" href="/assets/js/70.17b18a1a.js"><link rel="prefetch" href="/assets/js/71.39cd45c2.js"><link rel="prefetch" href="/assets/js/72.2b727976.js"><link rel="prefetch" href="/assets/js/73.5b0d3207.js"><link rel="prefetch" href="/assets/js/74.f992e12a.js"><link rel="prefetch" href="/assets/js/75.3511b5f6.js"><link rel="prefetch" href="/assets/js/76.45d3a0a8.js"><link rel="prefetch" href="/assets/js/77.b35f1dc0.js"><link rel="prefetch" href="/assets/js/78.8d27ada2.js"><link rel="prefetch" href="/assets/js/79.03333a9e.js"><link rel="prefetch" href="/assets/js/8.005f0859.js"><link rel="prefetch" href="/assets/js/80.20966bb7.js"><link rel="prefetch" href="/assets/js/81.bbad6aa9.js"><link rel="prefetch" href="/assets/js/82.3cadf2db.js"><link rel="prefetch" href="/assets/js/83.5923885a.js"><link rel="prefetch" href="/assets/js/84.bed49f1e.js"><link rel="prefetch" href="/assets/js/85.8ada4cf4.js"><link rel="prefetch" href="/assets/js/86.23c160fc.js"><link rel="prefetch" href="/assets/js/87.f1b16045.js"><link rel="prefetch" href="/assets/js/88.e59d9fbc.js"><link rel="prefetch" href="/assets/js/89.89b26741.js"><link rel="prefetch" href="/assets/js/9.fae1371e.js"><link rel="prefetch" href="/assets/js/90.13a1c791.js"><link rel="prefetch" href="/assets/js/91.0f5f61fa.js"><link rel="prefetch" href="/assets/js/92.c3d39ec4.js"><link rel="prefetch" href="/assets/js/93.a1f64002.js"><link rel="prefetch" href="/assets/js/94.327219d9.js"><link rel="prefetch" href="/assets/js/95.65616f44.js"><link rel="prefetch" href="/assets/js/96.b64f24b5.js"><link rel="prefetch" href="/assets/js/97.dfec418f.js"><link rel="prefetch" href="/assets/js/98.ae73227d.js"><link rel="prefetch" href="/assets/js/99.38cd213e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e5c8d458.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">戡玉的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>文章</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>web前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>游览器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/code/article/browser/1.html" class="sidebar-link">游览器的进程和线程</a></li><li><a href="/code/article/browser/2.html" aria-current="page" class="active sidebar-link">游览器解析与渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#整体流程概述" class="sidebar-link">整体流程概述</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#dns-域名解析" class="sidebar-link">DNS 域名解析</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#建立-tcp-链接" class="sidebar-link">建立 TCP 链接</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#发送-http-请求" class="sidebar-link">发送 HTTP 请求</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#服务器处理请求" class="sidebar-link">服务器处理请求</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#返回响应结果" class="sidebar-link">返回响应结果</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#关闭-tcp-连接" class="sidebar-link">关闭 TCP 连接</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#游览器解析渲染" class="sidebar-link">游览器解析渲染</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#相关知识补充" class="sidebar-link">相关知识补充</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#优化手段" class="sidebar-link">优化手段</a></li><li class="sidebar-sub-header"><a href="/code/article/browser/2.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="游览器解析与渲染"><a href="#游览器解析与渲染" class="header-anchor">#</a> 游览器解析与渲染</h1> <h2 id="整体流程概述"><a href="#整体流程概述" class="header-anchor">#</a> 整体流程概述</h2> <ol><li><p>DNS 域名解析</p></li> <li><p>建立 TCP 连接</p></li> <li><p>发送 HTTP 请求</p></li> <li><p>服务器处理请求</p></li> <li><p>返回响应结果</p></li> <li><p>关闭 TCP 连接</p></li> <li><p>浏览器解析渲染</p></li></ol> <h2 id="dns-域名解析"><a href="#dns-域名解析" class="header-anchor">#</a> DNS 域名解析</h2> <p><img src="/code/article/browser/2.png" alt=""></p> <ol><li><p>我们在游览器输入网址后，游览器会首先会去查找本地 hosts 文件，检查在该文件中是否有相应的域名、IP 对应关系，如果有，则向其 IP 地址发送请求，如果没有，再去找 DNS 服务器。</p></li> <li><p>在查询 DNS 服务器的过程中，客户端首先会向本地 DNS 服务器发送网址的查询报文，本地 DNS 服务器再把查询报文转发到根 DNS 服务器，根 DNS 服务器再根据网址后缀派发指定的节点 DNS 服务器，然后本地 DNS 服务器再向这个节点 DNS 服务器发送查询请求，后者返回该网址对应的 ip 地址。</p></li> <li><p>当本地 DNS 服务器的缓存中已有节点服务器的地址，则会直接向节点服务器发送查询请求，因此请求根域名服务器这一步不是必需的。</p></li> <li><p>从客户端到本地服务器属于递归查询，而 DNS 服务器之间的交互属于迭代查询。</p></li></ol> <h2 id="建立-tcp-链接"><a href="#建立-tcp-链接" class="header-anchor">#</a> 建立 TCP 链接</h2> <p>拿到服务器 ip 地址后，游览器客户端会开始与服务器进行交互，建立 TCP 链接，这个过程涉及<strong>三次握手</strong>，握手结束，则代表链接建立成功。</p> <p><img src="/code/article/browser/3.png" alt=""></p> <h2 id="发送-http-请求"><a href="#发送-http-请求" class="header-anchor">#</a> 发送 HTTP 请求</h2> <p>与服务器建立了连接后，就可以向服务器发起请求了。请求报文结构如下：</p> <p><img src="/code/article/browser/4.png" alt=""></p> <p><img src="/code/article/browser/5.png" alt=""></p> <h2 id="服务器处理请求"><a href="#服务器处理请求" class="header-anchor">#</a> 服务器处理请求</h2> <ul><li><p>请求收到后，先由 web 服务器（准确说应该是 http 服务器）处理请求，诸如 Apache、Ngnix、IIS 等，然后再进入服务端进行程序处理。</p></li> <li><p>服务端解析用户请求，知道了需要调度哪些资源文件，再通过相应的这些资源文件处理用户请求和参数，并调用数据库信息，最后将结果通过 web 服务器返回给浏览器客户端。</p></li></ul> <p><img src="/code/article/browser/6.png" alt=""></p> <h2 id="返回响应结果"><a href="#返回响应结果" class="header-anchor">#</a> 返回响应结果</h2> <p>服务器处理完请求后，就会发送响应结果，响应报文的结构如下：</p> <p><img src="/code/article/browser/7.png" alt=""></p> <p>响应结果中会有对应的 HTTP 状态码，可分为 5 类：</p> <p><img src="/code/article/browser/8.png" alt=""></p> <h2 id="关闭-tcp-连接"><a href="#关闭-tcp-连接" class="header-anchor">#</a> 关闭 TCP 连接</h2> <ul><li><p>为了避免服务器与客户端双方的资源占用和损耗，当双方没有请求或响应传递时，任意一方都可以发起关闭请求。</p></li> <li><p>与创建 TCP 连接的 3 次握手类似，关闭 TCP 连接，需要 4 次握手。</p></li></ul> <p><img src="/code/article/browser/9.png" alt=""></p> <h2 id="游览器解析渲染"><a href="#游览器解析渲染" class="header-anchor">#</a> 游览器解析渲染</h2> <h3 id="关键渲染路径"><a href="#关键渲染路径" class="header-anchor">#</a> 关键渲染路径</h3> <p>浏览器从最初接收请求来的 HTML、CSS、javascript 等资源，然后解析、构建树、渲染布局、绘制，最后呈现给客户能看到的界面这整个过程——简单来说，就是对游览器渲染过程的描述。</p> <h3 id="渲染步骤"><a href="#渲染步骤" class="header-anchor">#</a> 渲染步骤</h3> <ol><li><p>解析 html，生成 dom 树</p></li> <li><p>解析 css，生成 cssom 树</p></li> <li><p>将 dom 树和 cssom 树合并，生成渲染树</p></li> <li><p>遍历渲染树，开始布局和计算</p></li> <li><p>绘制渲染树，显示到屏幕</p></li></ol> <h3 id="渲染图示"><a href="#渲染图示" class="header-anchor">#</a> 渲染图示</h3> <p>以 webkit 渲染引擎为例</p> <p><img src="/code/article/browser/10.png" alt=""></p> <h3 id="渲染过程"><a href="#渲染过程" class="header-anchor">#</a> 渲染过程</h3> <h4 id="解析-html-生成-dom-树"><a href="#解析-html-生成-dom-树" class="header-anchor">#</a> 解析 html，生成 dom 树</h4> <ul><li><p>当浏览器接收到服务器响应来的 HTML 文档后，会自上而下扫描文档，开始解析，遍历文档节点，生成 DOM 树。</p></li> <li><p>整个构建过程其实包括： 字节 -&gt; 字符 -&gt; 令牌 -&gt; 节点对象 -&gt; 对象模型</p></li> <li><p>下面是示例代码和配图</p></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width,initial-scale=1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>style.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Critical Path<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Hello <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>web performance<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> students!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>awesome-photo.jpg<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/code/article/browser/11.png" alt=""></p> <h4 id="解析-css-生成-cssom-树"><a href="#解析-css-生成-cssom-树" class="header-anchor">#</a> 解析 css，生成 cssom 树</h4> <ul><li><p>解析 css 文件，生成 css 规则树。</p></li> <li><p>每个 css 文件都被分析成一个 stylesheet 对象，每个对象都包含 CSS 规则。</p></li> <li><p>css 规则对象包含对应于 css 语法的选择器和声明对象以及其他对象。</p></li> <li><p>构建过程没有什么特别的差别，下面是示例代码和配图：</p></li></ul> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">p</span> <span class="token punctuation">{</span>
  <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">span</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">p span</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">img</span> <span class="token punctuation">{</span>
  <span class="token property">float</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/code/article/browser/12.png" alt=""></p> <h4 id="将-dom-树和-cssom-树合并-生成渲染树"><a href="#将-dom-树和-cssom-树合并-生成渲染树" class="header-anchor">#</a> 将 dom 树和 cssom 树合并，生成渲染树</h4> <ul><li><p>浏览器会先从 dom 树的根节点开始遍历每个可见节点，找到其适配的 CSS 样式规则并应用。</p></li> <li><p>将 dom 树与 cssom 树结合在一起，这就是渲染树。</p></li></ul> <p><img src="/code/article/browser/13.png" alt=""></p> <ul><li><p>每一个渲染对象都对应着 dom 节点，但是非视觉（隐藏，不占位）dom 元素不会插入渲染树，如<code>&lt;head&gt;</code>元素或声明<code>display: none;</code>的元素。</p></li> <li><p>渲染对象与 dom 节点不是简单的一对一的关系，一个 dom 可以对应一个渲染对象，但一个 dom 元素也可能对应多个渲染对象，因为有很多元素不止包含一个 css 盒子。</p></li> <li><p>如当文本被折行时，会产生多个行盒，这些行会生成多个渲染对象；又如行内元素同时包含块元素和行内元素，则会创建一个匿名块级盒包含内部行内元素，此时一个 dom 对应多个渲染对象。</p></li></ul> <h4 id="遍历渲染树-开始布局和计算"><a href="#遍历渲染树-开始布局和计算" class="header-anchor">#</a> 遍历渲染树，开始布局和计算</h4> <ul><li><p>布局阶段会从渲染树的根节点开始遍历，然后确定每个节点对象在页面上的确切大小与位置。</p></li> <li><p>布局阶段的输出是一个盒子模型，它会精确地捕获每个元素在屏幕内的确切位置与大小，所有相对的测量值也都会被转换为屏幕内的绝对像素值。</p></li></ul> <h4 id="绘制渲染树-显示到屏幕"><a href="#绘制渲染树-显示到屏幕" class="header-anchor">#</a> 绘制渲染树，显示到屏幕</h4> <ul><li>在绘制阶段，浏览器会立即发出 Paint Setup 与 Paint 事件，开始将渲染树绘制成像素，绘制所需的时间跟 CSS 样式的复杂度成正比，绘制完成后，用户就可以看到页面的最终呈现效果了。</li></ul> <h2 id="相关知识补充"><a href="#相关知识补充" class="header-anchor">#</a> 相关知识补充</h2> <h3 id="资源并行加载"><a href="#资源并行加载" class="header-anchor">#</a> 资源并行加载</h3> <ul><li>现代浏览器总是并行加载资源，当 html 解析器被脚本阻塞时，解析器虽然会停止构建 dom，但仍会识别该脚本后面的资源，并进行预加载</li></ul> <h3 id="重绘-重排-回流"><a href="#重绘-重排-回流" class="header-anchor">#</a> 重绘/重排/回流</h3> <ul><li><p>重绘(replaint)——屏幕的一部分重画，不影响整体布局，比如某个 CSS 的背景色变了，但元素的几何尺寸和位置不变。</p></li> <li><p>重排(relayout)——意味着元件的几何尺寸变了，我们需要重新验证并计算渲染树。</p></li> <li><p>回流(reflow)——Gecko 中布局的称谓，同时也是重排的别称，是指渲染树的一部分或全部发生了变化。</p></li></ul> <h3 id="js-阻塞-dom-解析"><a href="#js-阻塞-dom-解析" class="header-anchor">#</a> js 阻塞 dom 解析</h3> <ul><li><p>由于 js 引擎和 gui 引擎互斥，所以当 js 执行的时候，gui 就会被挂起，dom 解析停滞，形成阻塞。</p></li> <li><p>值得注意的是，js 只会阻塞后续的 dom 而不一定是整个 dom，也就是说，在这个 js 前面的 dom 可以被正确地解析以及渲染（这也是为什么我们把脚本放在页面底部，脚本仍在下载时页面已经可以部分地正常显示）。</p></li></ul> <h3 id="css-阻塞-dom-解析"><a href="#css-阻塞-dom-解析" class="header-anchor">#</a> css 阻塞 dom 解析</h3> <ul><li><p>正常情况是不会的，但是当执行的 js 依赖于 css 的样式时就会发生，这种情况发生在<strong>css 文件排在 js 文件之前</strong>。</p></li> <li><p>当 js 执行时，考虑到文档解析，如果样式尚未加载或解析，将会得到错误信息。firefox 和 webkit 浏览器处理策略不同，前者会阻塞所有脚本，后者只会阻塞操作了该文件内声明的样式属性的脚本。</p></li> <li><p>当游览器考虑到 js 执行需要 css 时，通过处理策略阻塞 js 脚本，dom 解析自然也就被阻塞了，这也就是 css 为什么会阻塞 dom 解析</p></li></ul> <h3 id="css-阻塞-dom-渲染"><a href="#css-阻塞-dom-渲染" class="header-anchor">#</a> css 阻塞 dom 渲染</h3> <ul><li><p>默认情况下，css 被视为阻塞 dom 渲染的资源，这意味着浏览器直至 cssom 构建完毕之前将不会渲染任何已处理的内容，毕竟渲染树也依赖于 cssom 树。</p></li> <li><p>这也是为什么我们把样式放在 HTML 内容之前，以防止被呈现内容发生样式跳动。 当然代价就是显示延迟，所以性能攸关的站点都会内联所有 CSS</p></li></ul> <h3 id="动态插入-js-和-css-时"><a href="#动态插入-js-和-css-时" class="header-anchor">#</a> 动态插入 js 和 css 时</h3> <ul><li><p>动态插入的外部样式表或脚本不会阻塞 dom 解析或渲染。</p></li> <li><p>动态插入的内联样式表或脚本会阻塞 dom 解析和渲染。</p></li> <li><p>未加入到 dom 结构的样式表或脚本（外部或内联）不会被下载、解析或执行（<code>Image.src</code> 是特例）。</p></li> <li><p>使用 <code>innerHTML</code> 引入 <code>script</code> 标签，其中的 js 不会执行，但 link 标签会起作用。</p></li></ul> <h3 id="改变-js-阻塞的方式"><a href="#改变-js-阻塞的方式" class="header-anchor">#</a> 改变 js 阻塞的方式</h3> <ul><li><p><code>defer</code> 是渲染完再执行，<code>async</code> 是下载完就执行(即不能保证执行顺序)。</p></li> <li><p><code>defer</code> 相比普通 <code>script</code>，有两点区别——载入 js 文件时不阻塞 html 的解析，执行阶段被放到 html 标签解析完成之后。</p></li> <li><p><code>async</code> 加载的 js 依然会阻塞 <code>load</code> 事件。换句话说，<code>async-script</code> 可能在 <code>DOMContentLoaded</code> 触发之前或之后执行，但一定在 load 触发之前执行。</p></li> <li><p>两者只在外链 js 中有效，并且使用 <code>document.createElement</code> 创建的 <code>script</code> 默认是 <code>async</code> 的。</p></li></ul> <h3 id="渲染图层"><a href="#渲染图层" class="header-anchor">#</a> 渲染图层</h3> <h4 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h4> <ul><li><p>浏览器渲染的图层一般包含两大类：普通图层以及复合图层。</p></li> <li><p>首先，普通文档流内可以理解为一个复合图层，这里称为默认复合层，里面不管添加多少元素，其实都是在同一个复合图层中。</p></li> <li><p>其次，<code>absolute</code> 布局（<code>fixed</code> 也一样），虽然可以脱离普通文档流，但它仍然属于默认复合层。</p></li> <li><p>然后，可以通过硬件加速的方式，声明一个新的复合图层，它会单独分配资源 （当然也会脱离普通文档流，这样一来，不管这个复合图层中怎么变化，也不会影响默认复合层里的回流重绘）。</p></li> <li><p>可以简单地理解为，GPU 中各个复合图层是单独绘制的，所以互不影响，这也是为什么某些场景硬件加速效果一级棒。</p></li></ul> <h4 id="absolute-和硬件加速的区别"><a href="#absolute-和硬件加速的区别" class="header-anchor">#</a> absolute 和硬件加速的区别</h4> <ul><li><p>需要强调的是，<code>absolute</code> 虽然可以脱离普通文档流，但是无法脱离默认复合层。 所以，就算 <code>absolute</code> 中信息改变时不会改变普通文档流中 render 树， 但是，浏览器最终绘制时，是整个复合层绘制的，所以 <code>absolute</code> 中信息的改变，仍然会影响整个复合层的绘制（浏览器会重绘它，如果复合层中内容多，<code>absolute</code> 带来的绘制信息变化过大，资源消耗是非常严重的）。</p></li> <li><p>硬件加速直接就是在另一个复合层了，相当于另起炉灶，所以它的信息改变不会影响默认复合层 （当然了，内部肯定会影响属于自己的复合层），仅仅是引发最后的合成（输出视图）</p></li></ul> <h4 id="复合图层的作用"><a href="#复合图层的作用" class="header-anchor">#</a> 复合图层的作用</h4> <ul><li>一般一个元素开启硬件加速后会变成复合图层，可以独立于普通文档流中，改动后可以避免整个页面重绘，提升性能。但是尽量不要大量使用复合图层，否则由于资源消耗过度，页面反而会变的更卡</li></ul> <h4 id="如何变成复合图层-硬件加速"><a href="#如何变成复合图层-硬件加速" class="header-anchor">#</a> 如何变成复合图层（硬件加速）</h4> <ul><li><p>最常用的方式：<code>translate3d、translateZ</code></p></li> <li><p><code>opacity</code> 属性/过渡动画（需要动画执行的过程中才会创建合成层，动画没有开始或结束后元素还会回到之前的状态）</p></li> <li><p><code>will-chang</code> 属性（这个比较偏僻），一般配合<code>opacity</code> 与 <code>translate</code> 使用（而且经测试，除了上述可以引发硬件加速的属性外，其它属性并不会变成复合层）， 作用是提前告诉浏览器要变化，这样浏览器会开始做一些优化工作（这个最好用完后就释放）</p></li> <li><p><code>&lt;video&gt;&lt;iframe&gt;&lt;canvas&gt;&lt;webgl&gt;</code>等元素</p></li></ul> <h4 id="硬件加速时请使用-z-index"><a href="#硬件加速时请使用-z-index" class="header-anchor">#</a> 硬件加速时请使用 z-index</h4> <ul><li><p>使用硬件加速时，尽可能的使用 <code>z-index</code>，防止浏览器默认给后续的元素创建复合层渲染</p></li> <li><p>具体的原理时这样的： <code>webkit CSS3</code> 中，如果这个元素添加了硬件加速，并且 <code>z-index</code> 层级比较低， 那么在这个元素的后面其它元素（层级比这个元素高的，或者相同的，并且 <code>releative</code> 或 <code>absolute</code> 属性相同的）， 会默认变为复合层渲染，如果处理不当会极大的影响性能</p></li> <li><p>简单点理解，其实可以认为是一个隐式合成的概念：如果 a 是一个复合图层，而且 b 在 a 上面，那么 b 也会被隐式转为一个复合图层，这点需要特别注意</p></li></ul> <h2 id="优化手段"><a href="#优化手段" class="header-anchor">#</a> 优化手段</h2> <h3 id="针对-html"><a href="#针对-html" class="header-anchor">#</a> 针对 html</h3> <ul><li>html 文档结构层次尽量少，最好不深于 6 层</li> <li>首屏 html 可以少量，主体结构动态插入</li></ul> <h3 id="针对-css"><a href="#针对-css" class="header-anchor">#</a> 针对 css</h3> <ul><li>使用媒体查询，减少初次 cssom 树的构建量</li> <li>尽量用 id 和 class，不要过渡层叠</li> <li>样式结构层次尽量简单</li></ul> <h3 id="针对-js"><a href="#针对-js" class="header-anchor">#</a> 针对 js</h3> <ul><li>使用 defer 和 async，避免对文档的阻塞</li> <li>可以的话，动态插入 js，避免阻塞</li></ul> <h3 id="针对引入位置"><a href="#针对引入位置" class="header-anchor">#</a> 针对引入位置</h3> <ul><li>css 放到 head，让 cssom 树先行构建；js 放到<code>&lt;/body&gt;</code>前，保证 dom 树先行构建，不被阻塞</li> <li>避免 js 文件的插入跟在 css 文件之后，避免 css 解析对 js 执行的延迟，造成阻塞</li></ul> <h3 id="针对资源载入"><a href="#针对资源载入" class="header-anchor">#</a> 针对资源载入</h3> <ul><li>对页面资源进行压缩，对传输进行 gzip 压缩</li> <li>利用 link 标签的 rel 属性进行预解析，运用 http 缓存</li></ul> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="http://blog.codingplayboy.com/2017/03/29/webpage_render/" target="_blank" rel="noopener noreferrer">http://blog.codingplayboy.com/2017/03/29/webpage_render/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://web.jobbole.com/92765/" target="_blank" rel="noopener noreferrer">http://web.jobbole.com/92765/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/5a8e242c5188257a6b060000" target="_blank" rel="noopener noreferrer">https://juejin.im/post/5a8e242c5188257a6b060000<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/59d489156fb9a00a571d6509" target="_blank" rel="noopener noreferrer">https://juejin.im/post/59d489156fb9a00a571d6509<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kb.cnblogs.com/page/534571/" target="_blank" rel="noopener noreferrer">https://kb.cnblogs.com/page/534571/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/59c60691518825396f4f71a1" target="_blank" rel="noopener noreferrer">https://juejin.im/post/59c60691518825396f4f71a1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://harttle.land/2016/11/26/dynamic-dom-render-blocking.html" target="_blank" rel="noopener noreferrer">http://harttle.land/2016/11/26/dynamic-dom-render-blocking.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html" target="_blank" rel="noopener noreferrer">http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.xuecaijie.com/it/157.html" target="_blank" rel="noopener noreferrer">https://www.xuecaijie.com/it/157.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/code/article/browser/1.html" class="prev">
        游览器的进程和线程
      </a></span> <span class="next"><a href="/code/article/basics/1.html">
        正则表达式知识概览
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.89584af2.js" defer></script><script src="/assets/js/2.b85b6bc1.js" defer></script><script src="/assets/js/12.7ff2c931.js" defer></script>
  </body>
</html>
